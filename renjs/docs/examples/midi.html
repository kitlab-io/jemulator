<!DOCTYPE html>
<html>
	<head>
	    <title>RenJS Examples - Midi Player Plugin</title>
	    <!-- Meta -->
	    <meta charset="utf-8">
	    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	        	<meta name="title" content="RenJS">
	    <meta name="description" content="A Visual Novel creator made for writers!">
	    <meta name="author" content="lunafromthemoon">    
	    <link rel="shortcut icon" href="../favicon.ico"> 

	    <!-- Open Graph / Facebook -->
		<meta property="og:type" content="website">
		<meta property="og:url" content="https://renjs.fr/">
		<meta property="og:title" content="RenJS">
		<meta property="og:description" content="A Visual Novel creator made for writers!">
		<meta property="og:image" content="https://renjs.net/assets/images/thumbnail.png">

		<!-- Twitter -->
		<meta property="twitter:card" content="summary_large_image">
		<meta property="twitter:url" content="https://renjs.fr/">
		<meta property="twitter:title" content="RenJS">
		<meta property="twitter:description" content="A Visual Novel creator made for writers!">
		<meta property="twitter:image" content="https://renjs.net/assets/images/thumbnail.png"> 
	    <link rel="shortcut icon" href="../favicon.ico"> 
	    
	    <!-- Google Font -->
	    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700&display=swap" rel="stylesheet">
	    
	    <!-- FontAwesome JS-->
	    <script defer src="../assets/fontawesome/js/all.min.js"></script>
	     <link rel="stylesheet" href="../assets/css/prism.css" />

	    <!-- Theme CSS -->  
	    <link id="theme-style" rel="stylesheet" href="../assets/css/tabs.css">
	    <link id="theme-style" rel="stylesheet" href="../assets/css/theme.css">
	    
	</head>


	<body style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px;margin-right: 0px;">
		<header class="header fixed-top">	    
	        <div class="branding docs-branding">
	            <div class="container-fluid position-relative py-2">
	                <div class="docs-logo-wrapper">
		                <div class="site-logo"><a class="navbar-brand" href="../index.html"><img class="logo-icon mr-2" src="../assets/images/renjs-logo.svg" alt="logo"></a></div>    
	                </div><!--//docs-logo-wrapper-->
		            <div class="docs-top-utilities d-flex justify-content-end align-items-center">
						<ul class="social-list list-inline mx-md-3 mx-lg-5 mb-0 d-none d-lg-flex">
							<li class="list-inline-item"><a href="https://github.com/lunafromthemoon/RenJS-V2"><i class="fab fa-github fa-fw"></i></a></li>
				            <li class="list-inline-item"><a href="https://twitter.com/lunafromthem00n"><i class="fab fa-twitter fa-fw"></i></a></li>
			                <li class="list-inline-item"><a href="https://discord.gg/uSMpYFnHZN"><i class="fab fa-discord"></i></a></li>
			                <li class="list-inline-item"><a href="https://lunafromthemoon.itch.io/renjs"><i class="fab fa-itch-io"></i></a></li>
			            </ul><!--//social-list-->
			            <a href="../index.html#downloads" class="btn btn-primary d-none d-lg-flex">Download</a>
		            </div><!--//docs-top-utilities-->
	            </div><!--//container-->
	        </div><!--//branding-->
	    </header><!--//header-->
		
		<section id="downloads" class="cta-section py-5 theme-bg-dark position-relative">
			<div class="text-center">
	   			<img src="../assets/images/renjs-title-white.svg" class="m-3 w-25">
	   			<h1 class="title text-center text-white mb-5">Midi Player Plugin</h1>
	   		</div>
			<div id="renjs-canvas"></div>
		    <div class="container">
			   <div class="docs-overview py-5">
		    		
		    		  <section class="accordion">
					    <section class="accordion-tabs">
					      <button class="accordion-tab accordion-active" data-actab-group="0" data-actab-id="0"><i class="fas fa-pen-alt"></i> Story.yaml</button>
					      <button class="accordion-tab" data-actab-group="0" data-actab-id="1"><i class="fas fa-toolbox"></i> Configuration</button>
					      <button class="accordion-tab" data-actab-group="0" data-actab-id="2"><i class="fas fa-cog"></i> MidiPlayer.js</button>
					    </section>
					    <section class="accordion-content line-numbers">
					      <article class="accordion-item accordion-active" data-actab-group="0" data-actab-id="0">
					      	<h4 class="accordion-item__label"></h4>
					      	<div class="accordion-item__container">
	    						<pre><code class="language-yaml">
start:
  - call MidiPlayer: clairdelune
  - show street_morning:
  - ambient SAKURA:
  - show deuzi: normal AT CENTER WITH FADE
  - text: A Midi file (.MID or .MIDI extension) is a Musical Instrument Digital Interface file.
  - text: Unlike regular audio files like MP3s or WAVs, these don't contain actual audio data and are therefore much smaller in size. 
  - text: They instead explain what notes are played, when they're played, and how long or loud each note should be.
  - text: The midi player plugin uses the js library ToneJS to play the sounds for us directly in the browser.
  - text: The current music playing, Clair de Lune by Debussy, is a midi file of only 15kb!
  - deuzi says happy: Isn't it beautiful? Let's stay and listen some more!
  - text: To stop the sound, call the midi player plugin again, with the keyword (bold)stop(end), and that's it!
  - call MidiPlayer: stop
  - ambient CLEAR:
  - endgame:

									</code></pre>
							</div>
					      </article>
					      <article class="accordion-item" data-actab-group="0" data-actab-id="1">
					      	<h4 class="accordion-item__label"></h4>
					      	<div class="accordion-item__container">
					      		<p>In index.html, you need to load two extra libraries, that the plugin needs to work <a href="https://tonejs.github.io/">ToneJS</a>, and <a href="https://tonejs.github.io/Midi/">ToneJS-Midi</a>. You can link these libraries directly from the cdn, or download them and load them from your local game folder.</p>
	    						<pre><code class="language-html">
&lt;script type=&quot;text/javascript&quot; src=&quot;https://unpkg.com/tone@latest/build/Tone.js&quot;&gt;&lt;/script&gt;
&lt;script type=&quot;text/javascript&quot; src=&quot;https://unpkg.com/@tonejs/midi&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;assets/libs/MidiPlayer.js&quot;&gt;&lt;/script&gt;
								</code></pre>
							</div>
					      </article>
					      <article class="accordion-item" data-actab-group="0" data-actab-id="2">
					      	<h4 class="accordion-item__label"></h4>
					      	<div class="accordion-item__container">
	    						<pre><code class="language-js">
class MidiPlayer extends RenJS.Plugin {

    synths = [];
    midis = {};

    onInit() {
        
        const binaryLoadCallback = (key, data) => {
            // Convert our binary file into a Uint8Array
            const binarydata = new Uint8Array(data);
            // Convert the binary array to json
            this.midis[key] = new Midi(binarydata);
            return binarydata
        }
        //preload your midis here
        this.game.load.binary('clairdelune', 'assets/audio/clair-de-lune.mid', binaryLoadCallback, this.game);
        this.game.load.start();
    }

    onCall(params) {
        if (params.body == "stop"){
            this.stopMidi();
        } else {
            this.playMidi(params.body);
        }
        this.game.resolveAction();
    }

    playMidi(key){
        const now = Tone.now() + 0.5;

        this.midis[key].tracks.forEach((track) => {
            //create a synth for each track
            const synth = new Tone.PolySynth(Tone.Synth, {
                envelope: {
                    attack: 0.02,
                    decay: 0.1,
                    sustain: 0.3,
                    release: 1,
                },
            }).toDestination();
            // lower the volume a bit, or use the user volume
            // this.game.userPreferences.get('bgmv')
            synth.volume.value = -20;

            this.synths.push(synth);
            //schedule all of the events
            track.notes.forEach((note) => {
                if (note.duration>0){
                    synth.triggerAttackRelease(
                        note.name,
                        note.duration,
                        note.time + now,
                        note.velocity
                    );
                }
            });
        });
    }

    stopMidi(){
        while (this.synths.length) {
            const synth = this.synths.shift();
            synth.disconnect();
        }
    }
}

RenJSGame.addPlugin('MidiPlayer',MidiPlayer)
								</code></pre>
							</div>
					      </article>
					    </section>
					  </section>
		    	</div>
		    </div>
		    <p class="text-center mt-3">
                <a class="btn btn-cta-light" href="../examples-gallery.html"><i class="fas fa-arrow-left"></i> Return to the Gallery</a>
                <a class="btn btn-cta-light" href="https://github.com/lunafromthemoon/RenJS-V2/tree/main/docs/examples" target="_blank"><i class="fab fa-github fa-fw"></i> Download from Github</a>
            </p>  
		</section>
		<footer class="footer">
      <div class="footer-bottom text-center py-3">
            <p>Ren<strong>JS</strong> created by <strong><i class="fas fa-rocket"></i></strong> <a href="https://twitter.com/lunafromthem00n">lunafromthemoon</a> <strong><i class="fas fa-moon"></i></strong></p>
      </div>
    </footer>
	</body>
	<script src="../assets/js/prism.js"></script> 
	<script type="text/javascript" src="../assets/js/tabs.js"></script>
	<script src="/downloads/releases/renjs.js"></script>
	<script src="midi/boot.js"></script>
    <!-- The midi player needs the tonejs libraries -->
    <script type="text/javascript" src="https://unpkg.com/tone@latest/build/Tone.js"></script>
    <script type="text/javascript" src="https://unpkg.com/@tonejs/midi"></script>
	<script src="midi/MidiPlayer.js"></script>

</html>
