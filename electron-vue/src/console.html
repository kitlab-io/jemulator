<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="origin-trial"
      content="Aq6vv/4syIkcyMszFgCc9LlH0kX88jdE7SXfCFnh2RQN0nhhL8o6PCQ2oE3a7n3mC7+d9n89Repw5HYBtjarDw4AAAB3eyJvcmlnaW4iOiJodHRwczovL3B5b2RpZGUub3JnOjQ0MyIsImZlYXR1cmUiOiJXZWJBc3NlbWJseUpTUHJvbWlzZUludGVncmF0aW9uIiwiZXhwaXJ5IjoxNzMwMjQ2Mzk5LCJpc1N1YmRvbWFpbiI6dHJ1ZX0="
    />
    <meta
      http-equiv="origin-trial"
      content="Ai8IXb0XqedlM/Q2guWXFfBkKiYY9uaPZpdjHqc8y0ZvpAfK9SKzp/dIuFH+txG/HEKxt59uIkk39hhWrhNgbw4AAABieyJvcmlnaW4iOiJodHRwOi8vbG9jYWxob3N0OjgwMDAiLCJmZWF0dXJlIjoiV2ViQXNzZW1ibHlKU1Byb21pc2VJbnRlZ3JhdGlvbiIsImV4cGlyeSI6MTczMDI0NjM5OX0="
    />
    <script src="https://cdn.jsdelivr.net/npm/jquery"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery.terminal@2.35.2/js/jquery.terminal.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery.terminal@2.35.2/js/unix_formatting.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/jquery.terminal@2.35.2/css/jquery.terminal.min.css"
      rel="stylesheet"
    />
    <link
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üêç</text></svg>"
      rel="icon"
    />
    <style>
      .terminal {
        --size: 1.5;
        --color: rgba(255, 255, 255, 0.8);
      }
      .noblink {
        --animation: terminal-none;
      }
      body {
        background-color: black;
      }
      #jquery-terminal-logo {
        color: white;
        border-color: white;
        position: absolute;
        top: 7px;
        right: 18px;
        z-index: 2;
      }
      #jquery-terminal-logo a {
        color: gray;
        text-decoration: none;
        font-size: 0.7em;
      }
      #loading {
        display: inline-block;
        width: 50px;
        height: 50px;
        position: fixed;
        top: 50%;
        left: 50%;
        border: 3px solid rgba(172, 237, 255, 0.5);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        -webkit-animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          -webkit-transform: rotate(360deg);
        }
      }
      @-webkit-keyframes spin {
        to {
          -webkit-transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div id="jquery-terminal-logo">
      <a href="https://terminal.jcubic.pl/">jQuery Terminal</a>
    </div>
    <div id="loading"></div>
    <script>
      "use strict";

      function sleep(s) {
        return new Promise((resolve) => setTimeout(resolve, s));
      }

      // Device ID and state
      let deviceId = null;
      let deviceState = { status: 'initializing' };

      // Handle messages from main process
      if (window.electronAPI) {
        window.electronAPI.onMessage(async (message) => {
          console.log('Received message from main:', message);
          try {
            switch (message.type) {
              case 'init':
                deviceId = message.deviceId;
                document.title = `MicroPython Device: ${deviceId}`;
                break;
                
              case 'execute-code':
                if (term && pyconsole) {
                  term.exec(message.code);
                }
                break;
                
              case 'repl-input':
                if (term && pyconsole) {
                  term.exec(message.input);
                }
                break;
            }
          } catch (error) {
            console.error('Error handling message:', error);
            if (window.electronAPI) {
              window.electronAPI.sendToMain({
                type: 'error',
                message: error.message,
                stack: error.stack
              });
            }
          }
        });
      }

      async function main() {
        let indexURL = "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/";
        const urlParams = new URLSearchParams(window.location.search);
        const buildParam = urlParams.get("build");
        if (buildParam) {
          if (["full", "debug", "pyc"].includes(buildParam)) {
            indexURL = indexURL.replace(
              "/full/",
              "/" + urlParams.get("build") + "/",
            );
          } else {
            console.warn(
              'Invalid URL parameter: build="' +
                buildParam +
                '". Using default "full".',
            );
          }
        }
        const { loadPyodide } = await import(indexURL + "pyodide.mjs");
        // to facilitate debugging
        globalThis.loadPyodide = loadPyodide;

        let term;
        globalThis.pyodide = await loadPyodide({
          stdin: () => {
            let result = prompt();
            echo(result);
            return result;
          },
        });
        let { repr_shorten, BANNER, PyodideConsole } =
          pyodide.pyimport("pyodide.console");
        BANNER =
          `Welcome to the Pyodide ${pyodide.version} terminal emulator üêç\n` +
          BANNER;
        const pyconsole = PyodideConsole(pyodide.globals);

        const namespace = pyodide.globals.get("dict")();
        const await_fut = pyodide.runPython(
          `
          import builtins
          from pyodide.ffi import to_js

          async def await_fut(fut):
              res = await fut
              if res is not None:
                  builtins._ = res
              return to_js([res], depth=1)

          await_fut
          `,
          { globals: namespace },
        );
        namespace.destroy();

        const echo = (msg, ...opts) =>
          term.echo(
            msg
              .replaceAll("]]", "&rsqb;&rsqb;")
              .replaceAll("[[", "&lsqb;&lsqb;"),
            ...opts,
          );

        const ps1 = ">>> ";
        const ps2 = "... ";

        async function lock() {
          let resolve;
          const ready = term.ready;
          term.ready = new Promise((res) => (resolve = res));
          await ready;
          return resolve;
        }

        async function interpreter(command) {
          const unlock = await lock();
          term.pause();
          
          // Send REPL input to main process
          if (window.electronAPI) {
            window.electronAPI.sendToMain({
              type: 'repl-input',
              input: command
            });
          }
          
          // multiline should be split (useful when pasting)
          for (const c of command.split("\n")) {
            const escaped = c.replaceAll(/\u00a0/g, " ");
            const fut = pyconsole.push(escaped);
            term.set_prompt(fut.syntax_check === "incomplete" ? ps2 : ps1);
            switch (fut.syntax_check) {
              case "syntax-error":
                term.error(fut.formatted_error.trimEnd());
                continue;
              case "incomplete":
                continue;
              case "complete":
                break;
              default:
                throw new Error(`Unexpected type ${ty}`);
            }
            // In JavaScript, await automatically also awaits any results of
            // awaits, so if an async function returns a future, it will await
            // the inner future too. This is not what we want so we
            // temporarily put it into a list to protect it.
            const wrapped = await_fut(fut);
            // complete case, get result / error and print it.
            try {
              const [value] = await wrapped;
              if (value !== undefined) {
                echo(
                  repr_shorten.callKwargs(value, {
                    separator: "\n<long output truncated>\n",
                  }),
                );
              }
              if (value instanceof pyodide.ffi.PyProxy) {
                value.destroy();
              }
            } catch (e) {
              if (e.constructor.name === "PythonError") {
                const message = fut.formatted_error || e.message;
                term.error(message.trimEnd());
              } else {
                throw e;
              }
            } finally {
              fut.destroy();
              wrapped.destroy();
            }
          }
          term.resume();
          await sleep(10);
          unlock();
        }

        term = $("body").terminal(interpreter, {
          greetings: BANNER,
          prompt: ps1,
          completionEscape: false,
          completion: function (command, callback) {
            callback(pyconsole.complete(command).toJs()[0]);
          },
          keymap: {
            "CTRL+C": async function (event, original) {
              pyconsole.buffer.clear();
              term.enter();
              echo("KeyboardInterrupt");
              term.set_command("");
              term.set_prompt(ps1);
            },
            TAB: (event, original) => {
              const command = term.before_cursor();
              // Disable completion for whitespaces.
              if (command.trim() === "") {
                term.insert("\t");
                return false;
              }
              return original(event);
            },
          },
        });
        window.term = term;
        pyconsole.stdout_callback = (s) => {
          echo(s, { newline: false });
          // Send output to main process
          if (window.electronAPI) {
            window.electronAPI.sendToMain({
              type: 'console-output',
              text: s
            });
          }
        };
        pyconsole.stderr_callback = (s) => {
          term.error(s.trimEnd());
          // Send error to main process
          if (window.electronAPI) {
            window.electronAPI.sendToMain({
              type: 'console-error',
              text: s
            });
          }
        };
        term.ready = Promise.resolve();
        
        // Configure MicroPython environment
        try {
          await pyodide.runPythonAsync(`
            import sys
            sys.path.append('/lib')
            
            # Create MicroPython simulation environment
            class Pin:
                IN = 0
                OUT = 1
                PULL_UP = 2
                PULL_DOWN = 3
                
                def __init__(self, pin, mode=None, pull=None):
                    self.pin = pin
                    self.mode = mode
                    self.pull = pull
                    self._value = 0
                
                def on(self):
                    self._value = 1
                    print(f"PIN {self.pin} set to ON")
                
                def off(self):
                    self._value = 0
                    print(f"PIN {self.pin} set to OFF")
                
                def value(self, val=None):
                    if val is not None:
                        self._value = 1 if val else 0
                        print(f"PIN {self.pin} set to {self._value}")
                    return self._value
            
            class ADC:
                def __init__(self, pin):
                    self.pin = pin
                    
                def read(self):
                    # Simulate a random analog reading
                    import random
                    return random.randint(0, 4095)
            
            class UART:
                def __init__(self, id, baudrate=9600, tx=None, rx=None):
                    self.id = id
                    self.baudrate = baudrate
                    self.tx = tx
                    self.rx = rx
                    self.buffer = bytearray()
                    print(f"UART{id} initialized with baudrate {baudrate}")
                
                def write(self, data):
                    if isinstance(data, str):
                        data = data.encode('utf-8')
                    print(f"UART{self.id} write: {data}")
                    return len(data)
                
                def read(self, nbytes=None):
                    # Simulate reading data
                    import random
                    if nbytes is None:
                        nbytes = len(self.buffer)
                    if not self.buffer:
                        return b''
                    data = self.buffer[:nbytes]
                    self.buffer = self.buffer[nbytes:]
                    return data
                
                def any(self):
                    return len(self.buffer)
            
            class I2C:
                def __init__(self, id, scl=None, sda=None, freq=400000):
                    self.id = id
                    self.scl = scl
                    self.sda = sda
                    self.freq = freq
                    print(f"I2C{id} initialized with freq {freq}")
                
                def scan(self):
                    # Simulate finding some I2C devices
                    return [0x3C, 0x68]  # Example: OLED display and RTC
                
                def readfrom_mem(self, addr, memaddr, nbytes, addrsize=8):
                    # Simulate reading from I2C device memory
                    import random
                    return bytes([random.randint(0, 255) for _ in range(nbytes)])
                
                def writeto_mem(self, addr, memaddr, buf, addrsize=8):
                    # Simulate writing to I2C device memory
                    print(f"I2C write to device 0x{addr:02X}, addr 0x{memaddr:02X}, data: {buf}")
                    return len(buf)
            
            # Add to global namespace
            import builtins
            builtins.Pin = Pin
            builtins.ADC = ADC
            builtins.UART = UART
            builtins.I2C = I2C
            
            # Create machine module
            class MachineModule:
                def __init__(self):
                    self.Pin = Pin
                    self.ADC = ADC
                    self.UART = UART
                    self.I2C = I2C
                    
                def reset(self):
                    print("Machine reset simulated")
                    
                def freq(self, freq=None):
                    if freq is not None:
                        print(f"CPU frequency set to {freq} Hz")
                    return 240000000  # ESP32 default frequency
            
            machine = MachineModule()
            sys.modules['machine'] = machine
            
            # Create network module
            class WLAN:
                STA_IF = 0
                AP_IF = 1
                
                def __init__(self, interface_id):
                    self.interface_id = interface_id
                    self._active = False
                    self._connected = False
                    self._ssid = None
                    self._password = None
                    self._ip = None
                    
                def active(self, is_active=None):
                    if is_active is not None:
                        self._active = is_active
                        print(f"WLAN {'activated' if is_active else 'deactivated'}")
                    return self._active
                
                def connect(self, ssid, password):
                    if not self._active:
                        print("Cannot connect: WLAN not active")
                        return
                    self._ssid = ssid
                    self._password = password
                    self._connected = True
                    self._ip = "192.168.1.100"
                    print(f"Connected to WiFi network '{ssid}'")
                
                def disconnect(self):
                    self._connected = False
                    print("Disconnected from WiFi network")
                
                def isconnected(self):
                    return self._connected
                
                def ifconfig(self):
                    return (self._ip, "255.255.255.0", "192.168.1.1", "8.8.8.8")
            
            class NetworkModule:
                def __init__(self):
                    self.WLAN = WLAN
                    self.STA_IF = WLAN.STA_IF
                    self.AP_IF = WLAN.AP_IF
            
            network = NetworkModule()
            sys.modules['network'] = network
            
            print("MicroPython environment initialized")
          `);
          
          // Notify main process that device is ready
          if (window.electronAPI) {
            window.electronAPI.sendToMain({
              type: 'device-state',
              state: { status: 'ready', deviceId }
            });
          }
        } catch (error) {
          console.error('Error setting up MicroPython environment:', error);
          if (window.electronAPI) {
            window.electronAPI.sendToMain({
              type: 'error',
              message: error.message,
              stack: error.stack
            });
          }
        }
        pyodide._api.on_fatal = async (e) => {
          if (e.name === "Exit") {
            term.error(e);
            term.error("Pyodide exited and can no longer be used.");
          } else {
            term.error(
              "Pyodide has suffered a fatal error. Please report this to the Pyodide maintainers.",
            );
            term.error("The cause of the fatal error was:");
            term.error(e);
            term.error("Look in the browser console for more details.");
          }
          await term.ready;
          term.pause();
          await sleep(15);
          term.pause();
        };

        const searchParams = new URLSearchParams(window.location.search);
        if (searchParams.has("noblink")) {
          $(".cmd-cursor").addClass("noblink");
        }

        let idbkvPromise;
        async function getIDBKV() {
          if (!idbkvPromise) {
            idbkvPromise = await import(
              "https://unpkg.com/idb-keyval@5.0.2/dist/esm/index.js"
            );
          }
          return idbkvPromise;
        }

        async function mountDirectory(pyodideDirectory, directoryKey) {
          if (pyodide.FS.analyzePath(pyodideDirectory).exists) {
            return;
          }
          const { get, set } = await getIDBKV();
          const opts = {
            id: "mountdirid",
            mode: "readwrite",
          };
          let directoryHandle = await get(directoryKey);
          if (!directoryHandle) {
            directoryHandle = await showDirectoryPicker(opts);
            await set(directoryKey, directoryHandle);
          }
          const permissionStatus =
            await directoryHandle.requestPermission(opts);
          if (permissionStatus !== "granted") {
            throw new Error("readwrite access to directory not granted");
          }
          await pyodide.mountNativeFS(pyodideDirectory, directoryHandle);
        }
        globalThis.mountDirectory = mountDirectory;
      }
      window.console_ready = main();
    </script>
  </body>
</html>